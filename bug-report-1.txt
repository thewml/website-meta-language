Subject: Minimal perlembed test case fails to run a minimal script on cygwin64/win64/appveyor .

The test case here:

* https://github.com/thewml/website-meta-language/tree/reduce-appveyor-error (note the branch)

* https://ci.appveyor.com/project/shlomif/website-meta-language/builds/20374998

* https://travis-ci.org/thewml/website-meta-language/builds/456382402

fails to work on cygwin64 / appveyor while running fine on travis ci/ubuntu 14.04 x86-64.

The file is:

----------------------------------------------------------------------
#include <stdio.h>
#include <stdarg.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>

/*  first include the standard Perl
 *      includes designed for embedding   */
#if 0
#define PERL_NO_GET_CONTEXT     /* for efficiency reasons, see perlguts(3) */
#endif
#include <EXTERN.h>
#include <perl.h>

int Perl5_Run(int myargc, char **myargv, char **env)
{
    int rc;
    PerlInterpreter *my_perl = NULL;

    my_perl = perl_alloc();
    perl_construct(my_perl);

    /*  now parse the script!
        NOTICE: At this point, the script gets
        only _parsed_, not evaluated/executed!  */
    rc = perl_parse(my_perl, NULL, myargc, myargv, env);
    if (rc != 0) {
        fprintf(stderr, "Perl parsing error (interpreter rc=%d) error=%s", rc, SvTRUE(ERRSV) ? SvPV_nolen(ERRSV) : "");
        goto CUS;
    }

    /*  NOW IT IS TIME to evaluate/execute the script!!! */
    rc = perl_run(my_perl);

    CUS: /* the Clean Up Sequence */

    /* Ok, the script got evaluated. Now we can destroy
       and de-allocate the Perl interpreter */
    if (my_perl) {
       perl_destruct(my_perl);
       perl_free(my_perl);
    }
    return rc;
}

/*
 *  main procedure
 */
int main(int argc, char **argv, char **env)
{
    FILE *fp = NULL;
    char *perlscript = "ePerl.script";
    char *myargv[20];
    char *cpScript = "print \"foo\";\nprint \"\\n\";\0";

    if ((fp = fopen(perlscript, "w")) == NULL) {
        fprintf(stderr, "Cannot open Perl script file `%s' for writing", perlscript);
        return -1;
    }
    if (fwrite(cpScript, strlen(cpScript), 1, fp) != 1) {
        fprintf(stderr, "Cannot write to Perl script file `%s'", perlscript);
        return -1;
    }
    fclose(fp); fp = NULL;

    fprintf(stderr, "----internally created Perl script-----------------------------------\n%s\n--end--\n", cpScript);

    if ((fp = fopen(perlscript, "r")) == NULL) {
        fprintf(stderr, "Cannot open Perl script file `%s' for reading", perlscript);
        return -1;
    }
    fprintf(stderr, "----written Perl script-----------------------------------\n");
    while (!feof(fp)) {
        int c = fgetc(fp);
        if (c < 0) {
            break;
        }
        fprintf(stderr, "%c", (unsigned char)c);
    }
    fclose(fp); fp = NULL;
    fprintf(stderr, "\n\n end of----written Perl script-----------------------------------\n");
    /*  create command line...  */
    int myargc = 0;
    /*  - program name and possible -T -w options */
    myargv[myargc++] = argv[0];
    /*  - and the script itself  */
    myargv[myargc++] = perlscript;

    const int rc = Perl5_Run(myargc, myargv, env);
    return rc;
}
----------------------------------------------------------------------

It is built using

gcc -Wall -Wextra -o /home/appveyor/website-meta-language/build/tests/installation/lib/wml/exec/wml_p3_eperl ../src/p3_eperl/eperl_main.c `perl -MExtUtils::Embed -e ccopts -e ldopts`

and emits this output on cygwin64:


    [00:01:43] Running [prove -v t/03-p3_eperl.t]
    [00:01:44] ----internally created Perl script-----------------------------------
    [00:01:44] print "foo";
    [00:01:44] print "\n";
    [00:01:44] --end--
    [00:01:44] ----written Perl script-----------------------------------
    [00:01:44] print "foo";
    [00:01:44] print "\n";
    [00:01:44]
    [00:01:44]  end of----written Perl script-----------------------------------
    [00:01:44] Perl parsing error (interpreter rc=9) error=
    [00:01:44] #   Failed test 'generic system wml'
    [00:01:44] #   at t/03-p3_eperl.t line 12.
    [00:01:44]
    [00:01:44] #   Failed test 'generic cmp'
    [00:01:44] #   at t/03-p3_eperl.t line 29.
    [00:01:44] #          got: ''
    [00:01:44] #     expected: 'foo
    [00:01:44] # '
    [00:01:44] # Looks like you failed 2 tests of 2.
    [00:01:44] t/03-p3_eperl.t ..
    [00:01:44] 1..2
    [00:01:44] not ok 1 - generic system wml
    [00:01:44] not ok 2 - generic cmp
    [00:01:44] Dubious, test returned 2 (wstat 512, 0x200)
    [00:01:44] Failed 2/2 subtests
    [00:01:44]
    [00:01:44] Test Summary Report
    [00:01:44] -------------------
    [00:01:44] t/03-p3_eperl.t (Wstat: 512 Tests: 2 Failed: 2)
    [00:01:44]   Failed tests:  1-2
    [00:01:44]   Non-zero exit status: 2
    [00:01:44] Files=1, Tests=2,  1 wallclock secs ( 0.05 usr  0.00 sys +  0.11 cusr  0.01 csys =  0.17 CPU)
    [00:01:44] Result: FAIL
    [00:01:44] Running [prove -v t/03-p3_eperl.t] failed! at ../src/wml_test/cyg_test.pl line 17.
    [00:01:44] Died at appveyor.pl line 10.
    [00:01:44] Command exited with code 1

Please help.
